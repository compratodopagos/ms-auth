version: 1
backend:
  phases:
    build:
      commands:
        - nvm install 22 > /dev/null 2>&1
        - nvm use 22
        - npm ci --cache .npm --prefer-offline
        # Despliegue de backend Amplify
        - npx ampx pipeline-deploy --branch "$AWS_BRANCH" --app-id "$AWS_APP_ID"

frontend:
  phases:
    build:
      commands:
        # Detecta entorno según la rama
        - |
          if [ "$AWS_BRANCH" = "develop" ]; then
            export NG_ENV=development
          elif [ "$AWS_BRANCH" = "master" ]; then
            export NG_ENV=production
          else
            export NG_ENV=development  # Valor por defecto
          fi
          echo "Usando configuración Angular: $NG_ENV"

        # Construye la app Angular usando la configuración detectada
        - npm run build -- --configuration=$NG_ENV

  artifacts:
    baseDirectory: dist
    files:
      - '**/*'

  cache:
    paths:
      - .npm/**/*
      - node_modules/**/*